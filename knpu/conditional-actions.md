# Conditional Actions

New challenge. I only want this edit button to be visible and accessible for a user if I have the role super admin. This turns out to be a somewhat complicated thing to do because there are two sides to it. First, we need to block access to that action, so that someone can't be clever and hack to URL. Second, we want to actually hide the link so that it doesn't confuse our users.

Let's first lock down the actual controller. That one's a little bit easier because we can do it via events. What we basically want to do is disallow people to get to this edit action for a user unless they have the role super admin, which means we could, for example, override the edit actions that have a user controller or we can hook into the pre-edit event, which is what I'm going to do.

Let's subscribe to another event. Easy admin events, pre-edit on pre-edit. Once again, I'll hit option enter as a shortcut to create that method for me. We don't know what the event looks like, so let's dump it. Prefect. Now, as soon as I hit edit, we hit that dump and in this case the subject is actually an array, but inside it actually has a class key, which has the user in it, so we can use that to figure out if the event that's being dispatched is for the user class.

In other words, we can say, config equals event arrow get subject and if config class is equal to our user class, so user [inaudible 00:02:09] class, then we want to check security. I'm going to call a new method I'm going to create in a second called, deny access unless super admin and down at the bottom, let's create a private function, deny access unless super admin and inside here, we just need to check to see if the user has the super admin roll. To do that, we'll need the authorization checker service, so I'll type in authorization checker interface. Hit option enter, just as a shortcut to set that on a property. Then down below, we can say, if not, this error authorization checker error is granted, role super admin, then throw access denied exception.

Make sure you get the one from the security component. Whoops, that's throw new access not exception. In a controller when you call deny access unless granted, this is the exception that's thrown behind the scenes. So we're just doing the same thing that's normally done in a controller.

And that's it. This service is all wired so it should pass as the authorization checker automatically. So when we refresh, we are denied. Because our user does not have the role super admin role, just role admin and role user. To make sure the logic is correct, we can go into app config security dot yml, and temporarily, we'll give role admin, role super admin. So then I should have role super admin. Refresh, and I'm in. Great.

So, next step. I'll comment out that role super admin for now. On the list page, we need to hide the edit link, unless I have the roll. This is the tricky part. There's no official good hook inside of easy admin bundle to conditionally hide or show actions. However, earlier, when we overrode the list template, we were already taking control of the actions by sending them through a new filter admin actions filter that we created. That's being run by our easy admin extension.

So we've already created our own hook that's able to dynamically remove actions. So inside of here, we can do the same logic. And just like inside of our event subscriber, we're going to need to check to see if the user has role super admin. So I'm going to create public function construct, and then we're gonna inject the authorization checker interface again. Set that on a new property, and then down below, we can do something similar to before. We can say if item instance of user, this time, and not this authorization checker arrow is granted role super admin, then we know that we want unset the edit action.

So not the easiest thing ever, but it does get the job done. Except there's one problem, and that is if you use the show template, there's also an edit button right here. Which means we kind of need to do this same thing over again for the show template, not just the list template.

So here's what we'll do. Inside of the bundle, I'm going to find the show template. And I'll search in here for actions. Here we go, we can find block item actions. And so we can do a very similar thing to the list template. So actually copy the list template, and paste it to show. Because it's in the right location, it should automatically override the default line. And then we'll extend the base one. Now before, I overrode list item actions and then called the parent function. That actually won't work here. The difference is that the variable, this case it's called underscore show actions, is actually set right inside the block. For list, it was set above the block. That means if we override it and then call the parent block, it's going to reoverride it to the original value.

No problem, means that we just need to override the entire block. So I'll copy that, go to our show dot [inaudible 00:07:32], and we're going to paste that there. Then we just need to set our filter. Set underscore show actions equals underscore show actions, pipe filter, admin actions. In this case, remember we need to pass it the actual entity object. That's another difference in the show template. In this case, it's not called ... because we're dealing with a single entity, it's not called item anymore, it's actually called entity.

So that, crazy as it looks, should do it. Let's give it a try. And it works. No edit button. Let's go back to security dot yml, put back my role super admin, refresh, and we got it. Edit button's back, and we can even use it. So that's one of the tougher things to do, but we nailed it.

