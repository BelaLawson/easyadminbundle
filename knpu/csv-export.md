# CSV Export

One of the questions we've gotten is how to add a CSV export to these admin areas. Actually, it's a little bit tricky. What we want is probably a button up at top that says download CSV or something like that. It turns out on the list page, if you add custom actions, those custom actions go next to each item, which isn't exactly what we need.

Let's see if we can figure this out. First, in config dot YML, under the global list, I'm actually going to add a new action called export. Now, if we refresh, not surprisingly this means that ever list page now has an export link, which is not what we want. If we click it, it tries to execute a new export action. This is a custom action, like we did earlier.

It's added a link, which we don't want, and we'll fix that in a second. We do need to add this export here because it makes that a valid action, makes it something that we could actually create link to somewhere else.

Open up our custom list dot HTML dot twig, and also I'm going to hold command and go to the parent list dot HTML dot twig that lives inside of the bundle. If you scroll down a little bit, you'll find the block called global actions. You can see it kind of rendering some things with the search field. This global actions is this area up here. In other words, if we want to add something custom, global actions is the place to do it. Let's copy that block name and over ride it inside of our template. Global actions, end block. Inside of here I'm going to add that export button, but here's an idea. This download CSV might not be something we want on all of our entities. I've added it to the global list config, but we can still do a minus export on any of the other entities if we want to. I only want to show this export button if it's supported by that particular entity.

In the [inaudible 00:02:40] template you can see a really cool if statement that you can use to check to see if an action is enabled. I'm going to steal that and use it on ours. In this case we'll change search to export. Here's the deal. This point we know that the export button is enabled for this entity. I'm just going to create a custom button myself. A button action did for styling. Then I'll create a link. We're going to give it an H ref, that points to that new export action manually. In other words, we can do a path to easy admin, the one route inside of this. I'm actually going to use a special underscore request underscore parameters function variable. This is something that easy admin model gives us access to and it contains all of the query parameters. You'll see why that's important in a second.

The most important thing though is we're going to actually going to merge that with a new query parameter called action set to export. I think that looks really, really ugly but it's basically generating a route to easy admin where an action is set to export and I want to keep any query parameters that I have currently.

That's it. Inside we'll add a little FAFA download. We'll say export cool. Let's try it. Refresh. Now we have our export button and nothing else, because of course I forgot to call my parent function. Try that again. Perfect.

When I click export, just like before when we did a custom action it's going to look for an export action method inside of our controller, in this case genius controller. To make that error, remember we're not going to support this for all of our entities. To make the air clearer, I'm going to go into admin controller, our base controller and create public function export action that just throws an exception, through a new slash runtime exception, and we'll say action for exporting an entity not defined. You should never see this if we have everything configured correctly, but just in case. Now we see that error.

To implement this method, for our genius, we have two different options. Just like before, if we want in admin controller we can make a public function export genius action. Whenever it calls any of our actions even custom actions that always looks for that special named method. Or we can go the route we're using, which is that each entity that needs custom code, has its own controller. In genius controller, we'll make a public function export action. It's just that simple.

Now, we've already done most of the work of CSV export inside the service directory, there's already a CSV exporter class that we made and basically if you pass a document query builder, some information column, and this can actually also be the entity name. We'll have a special function down here, which maps column IDs for each entity. The file name we want, this will actually create the CSV for us and return it. All we need to do is basically prepare a query builder and call this method on this service.

I'm going to start by placing a little bit of code inside of this method. Remember when we created a link, we kept the query parameters from the page. That's actually going to include the sort direction and sort field query parameters so that our CSV actually comes out in whatever way that the user has the page sorted. That's kind of cool.

To create the query builder, we can actually use a protected functions on the base class called create class query builder. We need to pass the entity class new, which of course will be our genius class. You can also use this arrow entity arrow class. Just in case you maybe wanted to make this method more dynamic in the future. How do I know I can use this entity class? Remember, on every page we have this entity class. Every page we have the profile for easy admin bundle.

No, let's not do that. That entity variable property always contains a bunch of information either an object or an array of information about it. You can dump it to figure out what's inside. Next, we'll pass the sort direction. Then we can pass the sort field request, this arrow request, arrow query, arrow get, and it's called sort field if you look at the query parameters. Finally, we're going to pass it the option on the DQL filter. Again, this is kind of cool. We can use the entity configuration, to actually read off the list key and read off the DQL underscore filter key. If we do have a DQL filter on this, I'll actually be used inside of our CSV export.

Okay, we are ready. The last thing we need to do is actually use our CSV exporter class. Because I'm using the new symphony 3.3 configuration, CSV exporter is already registered as a service, but it's a private service, which means I can't use this arrow container arrow get. The 3.3 way of doing things is actually to type hint that service as an argument to our action, but remember these aren't real action. These are fake actions that are called by easy admin bundles. You can't type in the request. You can't type hints, services or anything like that. Instead, we're actually going to use classic dependency injection because this controller is registered as a service. Either construct function and we're just going to import CSV exporter, set that on a property, and then down below I'm just going to return this arrow CSV exporter arrow get response from query builder. We'll just pass it in query builder. Genius class, which is the second argument and also geniuses dot CSV.

Okay. Really diving down into some of the deeper parts of the bundle now. We can refresh the export though, and it downloads. Geniuses dot CSV. I'll go over in my terminal. I'll cap downloads genius dot CSV and there it is. The only last problem that we have is if we go back to the list page, we still have this weird export link that's showing up on every row. It works, but it's not actually what we want. Remember we have that just because we added it up here and we had to add it up there so that became a valid action that we could actually call. We need to hide that manually.

Fortunately we already have a filter to do this. It's once again our easy admin extension filter actions, which is called whenever these actions are rendered over here. Quite simply, we're just going to unset item actions export. I'll put a little comment that says, this action is rendered manually. Want to refresh. We have an export button on top, but not an export button on each row. It's a little tricky but it is a valid use of custom actions.

